{% extends 'admin/master.html' %}
{% block body %}
  <h3>Lines for Lesson: {{ lesson.title }}</h3>

  <form id="reorderForm" method="POST" action="{{ url_for('line.reorder_view', lesson_id=lesson.id) }}">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Order</th>
          <th>Text</th>
          <th>Audio</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="linesTbody">
        {% for line in lines|sort(attribute='order') %}
        <tr data-id="{{ line.id }}">
          <td class="order-cell">{{ line.order }}</td>
          <td>{{ line.text }}</td>
          <td>
            {% if line.audio_file %}
              <audio controls>
                <source src="{{ url_for('admin_files.serve_audio', filename=line.audio_file) }}">
              </audio>
            {% else %}
              No audio
            {% endif %}
          </td>
          <td>
            <a href="{{ url_for('line.edit_view', id=line.id) }}" class="btn btn-sm btn-primary">Edit</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <button type="submit" class="btn btn-primary">Save Order</button>
    <a href="{{ url_for('lesson.index_view') }}" class="btn btn-secondary">Back to Lessons</a>
  </form>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
    const tbody = document.getElementById('linesTbody');

    // Enable drag and drop on tbody rows
    new Sortable(tbody, {
      animation: 150,
      ghostClass: 'sortable-ghost',
      onEnd: () => {
        // Update order numbers visually after drag ends
        [...tbody.querySelectorAll('tr')].forEach((tr, index) => {
          tr.querySelector('.order-cell').textContent = index + 1;
        });
      }
    });

    // Before form submit, add hidden inputs with line ids in current order
    document.getElementById('reorderForm').addEventListener('submit', function(event) {
      // Remove old hidden inputs
      [...this.querySelectorAll('input[name="ordered_line_ids"]')].forEach(el => el.remove());

      // Add hidden inputs with new order
      [...tbody.querySelectorAll('tr')].forEach(tr => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'ordered_line_ids';
        input.value = tr.getAttribute('data-id');
        this.appendChild(input);
      });
    });
  </script>
{% endblock %}
